"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getBucketEndpointPlugin = exports.bucketEndpointMiddlewareOptions = exports.bucketEndpointMiddleware = void 0;
var tslib_1 = require("tslib");
var protocol_http_1 = require("@aws-sdk/protocol-http");
var util_arn_parser_1 = require("@aws-sdk/util-arn-parser");
var bucketHostname_1 = require("./bucketHostname");
var bucketHostnameUtils_1 = require("./bucketHostnameUtils");
function bucketEndpointMiddleware(options) {
    var _this = this;
    return function (next, context) { return function (args) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
        var bucketName, replaceBucketInPath, request, bucketArn, clientRegion, _a, _b, partition, signingRegion, useArnRegion, _c, hostname, bucketEndpoint, _d, hostname, bucketEndpoint;
        return tslib_1.__generator(this, function (_e) {
            switch (_e.label) {
                case 0:
                    bucketName = args.input.Bucket;
                    replaceBucketInPath = options.bucketEndpoint;
                    request = args.request;
                    if (!protocol_http_1.HttpRequest.isInstance(request)) return [3 /*break*/, 7];
                    if (!options.bucketEndpoint) return [3 /*break*/, 1];
                    request.hostname = bucketName;
                    return [3 /*break*/, 6];
                case 1:
                    if (!util_arn_parser_1.validate(bucketName)) return [3 /*break*/, 5];
                    bucketArn = util_arn_parser_1.parse(bucketName);
                    _a = bucketHostnameUtils_1.getPseudoRegion;
                    return [4 /*yield*/, options.region()];
                case 2:
                    clientRegion = _a.apply(void 0, [_e.sent()]);
                    return [4 /*yield*/, options.regionInfoProvider(clientRegion)];
                case 3:
                    _b = (_e.sent()) || {}, partition = _b.partition, signingRegion = _b.signingRegion;
                    return [4 /*yield*/, options.useArnRegion()];
                case 4:
                    useArnRegion = _e.sent();
                    _c = bucketHostname_1.bucketHostname({
                        bucketName: bucketArn,
                        baseHostname: request.hostname,
                        accelerateEndpoint: options.useAccelerateEndpoint,
                        dualstackEndpoint: options.useDualstackEndpoint,
                        pathStyleEndpoint: options.forcePathStyle,
                        tlsCompatible: request.protocol === "https:",
                        useArnRegion: useArnRegion,
                        clientPartition: partition,
                        clientSigningRegion: signingRegion,
                    }), hostname = _c.hostname, bucketEndpoint = _c.bucketEndpoint;
                    // If the request needs to use a region inferred from ARN that different from client region, we need to set
                    // them in the handler context so the signer will use them
                    if (useArnRegion && clientRegion !== bucketArn.region) {
                        context["signing_region"] = bucketArn.region;
                    }
                    request.hostname = hostname;
                    replaceBucketInPath = bucketEndpoint;
                    return [3 /*break*/, 6];
                case 5:
                    _d = bucketHostname_1.bucketHostname({
                        bucketName: bucketName,
                        baseHostname: request.hostname,
                        accelerateEndpoint: options.useAccelerateEndpoint,
                        dualstackEndpoint: options.useDualstackEndpoint,
                        pathStyleEndpoint: options.forcePathStyle,
                        tlsCompatible: request.protocol === "https:",
                    }), hostname = _d.hostname, bucketEndpoint = _d.bucketEndpoint;
                    request.hostname = hostname;
                    replaceBucketInPath = bucketEndpoint;
                    _e.label = 6;
                case 6:
                    if (replaceBucketInPath) {
                        request.path = request.path.replace(/^(\/)?[^\/]+/, "");
                        if (request.path === "") {
                            request.path = "/";
                        }
                    }
                    _e.label = 7;
                case 7: return [2 /*return*/, next(tslib_1.__assign(tslib_1.__assign({}, args), { request: request }))];
            }
        });
    }); }; };
}
exports.bucketEndpointMiddleware = bucketEndpointMiddleware;
exports.bucketEndpointMiddlewareOptions = {
    tags: ["BUCKET_ENDPOINT"],
    name: "bucketEndpointMiddleware",
    relation: "before",
    toMiddleware: "hostHeaderMiddleware",
};
exports.getBucketEndpointPlugin = function (options) { return ({
    applyToStack: function (clientStack) {
        clientStack.addRelativeTo(bucketEndpointMiddleware(options), exports.bucketEndpointMiddlewareOptions);
    },
}); };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0RW5kcG9pbnRNaWRkbGV3YXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2J1Y2tldEVuZHBvaW50TWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsd0RBQXFEO0FBV3JELDREQUFzRjtBQUV0RixtREFBa0Q7QUFDbEQsNkRBQXdEO0FBR3hELFNBQWdCLHdCQUF3QixDQUFDLE9BQXFDO0lBQTlFLGlCQTREQztJQTNEQyxPQUFPLFVBQ0wsSUFBK0IsRUFDL0IsT0FBZ0MsSUFDRixPQUFBLFVBQU8sSUFBZ0M7Ozs7O29CQUNyRCxVQUFVLEdBQUssSUFBSSxDQUFDLEtBQTJCLE9BQXJDLENBQXNDO29CQUM1RCxtQkFBbUIsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDO29CQUMzQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQzt5QkFDekIsMkJBQVcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQS9CLHdCQUErQjt5QkFDN0IsT0FBTyxDQUFDLGNBQWMsRUFBdEIsd0JBQXNCO29CQUN4QixPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQzs7O3lCQUNyQiwwQkFBVyxDQUFDLFVBQVUsQ0FBQyxFQUF2Qix3QkFBdUI7b0JBQzFCLFNBQVMsR0FBRyx1QkFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUNsQixLQUFBLHFDQUFlLENBQUE7b0JBQUMscUJBQU0sT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFBOztvQkFBckQsWUFBWSxHQUFHLGtCQUFnQixTQUFzQixFQUFDO29CQUN0QixxQkFBTSxPQUFPLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLEVBQUE7O29CQUE5RSxLQUErQixDQUFDLFNBQThDLENBQUMsSUFBSSxFQUFFLEVBQW5GLFNBQVMsZUFBQSxFQUFFLGFBQWEsbUJBQUE7b0JBQ1gscUJBQU0sT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFBOztvQkFBM0MsWUFBWSxHQUFHLFNBQTRCO29CQUMzQyxLQUErQiwrQkFBYyxDQUFDO3dCQUNsRCxVQUFVLEVBQUUsU0FBUzt3QkFDckIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxRQUFRO3dCQUM5QixrQkFBa0IsRUFBRSxPQUFPLENBQUMscUJBQXFCO3dCQUNqRCxpQkFBaUIsRUFBRSxPQUFPLENBQUMsb0JBQW9CO3dCQUMvQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsY0FBYzt3QkFDekMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUTt3QkFDNUMsWUFBWSxjQUFBO3dCQUNaLGVBQWUsRUFBRSxTQUFTO3dCQUMxQixtQkFBbUIsRUFBRSxhQUFhO3FCQUNuQyxDQUFDLEVBVk0sUUFBUSxjQUFBLEVBQUUsY0FBYyxvQkFBQSxDQVU3QjtvQkFFSCwyR0FBMkc7b0JBQzNHLDBEQUEwRDtvQkFDMUQsSUFBSSxZQUFZLElBQUksWUFBWSxLQUFLLFNBQVMsQ0FBQyxNQUFNLEVBQUU7d0JBQ3JELE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUM7cUJBQzlDO29CQUVELE9BQU8sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO29CQUM1QixtQkFBbUIsR0FBRyxjQUFjLENBQUM7OztvQkFFL0IsS0FBK0IsK0JBQWMsQ0FBQzt3QkFDbEQsVUFBVSxZQUFBO3dCQUNWLFlBQVksRUFBRSxPQUFPLENBQUMsUUFBUTt3QkFDOUIsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLHFCQUFxQjt3QkFDakQsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLG9CQUFvQjt3QkFDL0MsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLGNBQWM7d0JBQ3pDLGFBQWEsRUFBRSxPQUFPLENBQUMsUUFBUSxLQUFLLFFBQVE7cUJBQzdDLENBQUMsRUFQTSxRQUFRLGNBQUEsRUFBRSxjQUFjLG9CQUFBLENBTzdCO29CQUVILE9BQU8sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO29CQUM1QixtQkFBbUIsR0FBRyxjQUFjLENBQUM7OztvQkFHdkMsSUFBSSxtQkFBbUIsRUFBRTt3QkFDdkIsT0FBTyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7d0JBQ3hELElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxFQUFFLEVBQUU7NEJBQ3ZCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO3lCQUNwQjtxQkFDRjs7d0JBR0gsc0JBQU8sSUFBSSx1Q0FBTSxJQUFJLEtBQUUsT0FBTyxTQUFBLElBQUcsRUFBQzs7O1NBQ25DLEVBdkQrQixDQXVEL0IsQ0FBQztBQUNKLENBQUM7QUE1REQsNERBNERDO0FBRVksUUFBQSwrQkFBK0IsR0FBOEI7SUFDeEUsSUFBSSxFQUFFLENBQUMsaUJBQWlCLENBQUM7SUFDekIsSUFBSSxFQUFFLDBCQUEwQjtJQUNoQyxRQUFRLEVBQUUsUUFBUTtJQUNsQixZQUFZLEVBQUUsc0JBQXNCO0NBQ3JDLENBQUM7QUFFVyxRQUFBLHVCQUF1QixHQUFHLFVBQUMsT0FBcUMsSUFBMEIsT0FBQSxDQUFDO0lBQ3RHLFlBQVksRUFBRSxVQUFDLFdBQVc7UUFDeEIsV0FBVyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLENBQUMsRUFBRSx1Q0FBK0IsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7Q0FDRixDQUFDLEVBSnFHLENBSXJHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwUmVxdWVzdCB9IGZyb20gXCJAYXdzLXNkay9wcm90b2NvbC1odHRwXCI7XG5pbXBvcnQge1xuICBCdWlsZEhhbmRsZXIsXG4gIEJ1aWxkSGFuZGxlckFyZ3VtZW50cyxcbiAgQnVpbGRIYW5kbGVyT3V0cHV0LFxuICBCdWlsZE1pZGRsZXdhcmUsXG4gIEhhbmRsZXJFeGVjdXRpb25Db250ZXh0LFxuICBNZXRhZGF0YUJlYXJlcixcbiAgUGx1Z2dhYmxlLFxuICBSZWxhdGl2ZU1pZGRsZXdhcmVPcHRpb25zLFxufSBmcm9tIFwiQGF3cy1zZGsvdHlwZXNcIjtcbmltcG9ydCB7IHBhcnNlIGFzIHBhcnNlQXJuLCB2YWxpZGF0ZSBhcyB2YWxpZGF0ZUFybiB9IGZyb20gXCJAYXdzLXNkay91dGlsLWFybi1wYXJzZXJcIjtcblxuaW1wb3J0IHsgYnVja2V0SG9zdG5hbWUgfSBmcm9tIFwiLi9idWNrZXRIb3N0bmFtZVwiO1xuaW1wb3J0IHsgZ2V0UHNldWRvUmVnaW9uIH0gZnJvbSBcIi4vYnVja2V0SG9zdG5hbWVVdGlsc1wiO1xuaW1wb3J0IHsgQnVja2V0RW5kcG9pbnRSZXNvbHZlZENvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ3VyYXRpb25zXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBidWNrZXRFbmRwb2ludE1pZGRsZXdhcmUob3B0aW9uczogQnVja2V0RW5kcG9pbnRSZXNvbHZlZENvbmZpZyk6IEJ1aWxkTWlkZGxld2FyZTxhbnksIGFueT4ge1xuICByZXR1cm4gPE91dHB1dCBleHRlbmRzIE1ldGFkYXRhQmVhcmVyPihcbiAgICBuZXh0OiBCdWlsZEhhbmRsZXI8YW55LCBPdXRwdXQ+LFxuICAgIGNvbnRleHQ6IEhhbmRsZXJFeGVjdXRpb25Db250ZXh0XG4gICk6IEJ1aWxkSGFuZGxlcjxhbnksIE91dHB1dD4gPT4gYXN5bmMgKGFyZ3M6IEJ1aWxkSGFuZGxlckFyZ3VtZW50czxhbnk+KTogUHJvbWlzZTxCdWlsZEhhbmRsZXJPdXRwdXQ8T3V0cHV0Pj4gPT4ge1xuICAgIGNvbnN0IHsgQnVja2V0OiBidWNrZXROYW1lIH0gPSBhcmdzLmlucHV0IGFzIHsgQnVja2V0OiBzdHJpbmcgfTtcbiAgICBsZXQgcmVwbGFjZUJ1Y2tldEluUGF0aCA9IG9wdGlvbnMuYnVja2V0RW5kcG9pbnQ7XG4gICAgY29uc3QgcmVxdWVzdCA9IGFyZ3MucmVxdWVzdDtcbiAgICBpZiAoSHR0cFJlcXVlc3QuaXNJbnN0YW5jZShyZXF1ZXN0KSkge1xuICAgICAgaWYgKG9wdGlvbnMuYnVja2V0RW5kcG9pbnQpIHtcbiAgICAgICAgcmVxdWVzdC5ob3N0bmFtZSA9IGJ1Y2tldE5hbWU7XG4gICAgICB9IGVsc2UgaWYgKHZhbGlkYXRlQXJuKGJ1Y2tldE5hbWUpKSB7XG4gICAgICAgIGNvbnN0IGJ1Y2tldEFybiA9IHBhcnNlQXJuKGJ1Y2tldE5hbWUpO1xuICAgICAgICBjb25zdCBjbGllbnRSZWdpb24gPSBnZXRQc2V1ZG9SZWdpb24oYXdhaXQgb3B0aW9ucy5yZWdpb24oKSk7XG4gICAgICAgIGNvbnN0IHsgcGFydGl0aW9uLCBzaWduaW5nUmVnaW9uIH0gPSAoYXdhaXQgb3B0aW9ucy5yZWdpb25JbmZvUHJvdmlkZXIoY2xpZW50UmVnaW9uKSkgfHwge307XG4gICAgICAgIGNvbnN0IHVzZUFyblJlZ2lvbiA9IGF3YWl0IG9wdGlvbnMudXNlQXJuUmVnaW9uKCk7XG4gICAgICAgIGNvbnN0IHsgaG9zdG5hbWUsIGJ1Y2tldEVuZHBvaW50IH0gPSBidWNrZXRIb3N0bmFtZSh7XG4gICAgICAgICAgYnVja2V0TmFtZTogYnVja2V0QXJuLFxuICAgICAgICAgIGJhc2VIb3N0bmFtZTogcmVxdWVzdC5ob3N0bmFtZSxcbiAgICAgICAgICBhY2NlbGVyYXRlRW5kcG9pbnQ6IG9wdGlvbnMudXNlQWNjZWxlcmF0ZUVuZHBvaW50LFxuICAgICAgICAgIGR1YWxzdGFja0VuZHBvaW50OiBvcHRpb25zLnVzZUR1YWxzdGFja0VuZHBvaW50LFxuICAgICAgICAgIHBhdGhTdHlsZUVuZHBvaW50OiBvcHRpb25zLmZvcmNlUGF0aFN0eWxlLFxuICAgICAgICAgIHRsc0NvbXBhdGlibGU6IHJlcXVlc3QucHJvdG9jb2wgPT09IFwiaHR0cHM6XCIsXG4gICAgICAgICAgdXNlQXJuUmVnaW9uLFxuICAgICAgICAgIGNsaWVudFBhcnRpdGlvbjogcGFydGl0aW9uLFxuICAgICAgICAgIGNsaWVudFNpZ25pbmdSZWdpb246IHNpZ25pbmdSZWdpb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIElmIHRoZSByZXF1ZXN0IG5lZWRzIHRvIHVzZSBhIHJlZ2lvbiBpbmZlcnJlZCBmcm9tIEFSTiB0aGF0IGRpZmZlcmVudCBmcm9tIGNsaWVudCByZWdpb24sIHdlIG5lZWQgdG8gc2V0XG4gICAgICAgIC8vIHRoZW0gaW4gdGhlIGhhbmRsZXIgY29udGV4dCBzbyB0aGUgc2lnbmVyIHdpbGwgdXNlIHRoZW1cbiAgICAgICAgaWYgKHVzZUFyblJlZ2lvbiAmJiBjbGllbnRSZWdpb24gIT09IGJ1Y2tldEFybi5yZWdpb24pIHtcbiAgICAgICAgICBjb250ZXh0W1wic2lnbmluZ19yZWdpb25cIl0gPSBidWNrZXRBcm4ucmVnaW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVxdWVzdC5ob3N0bmFtZSA9IGhvc3RuYW1lO1xuICAgICAgICByZXBsYWNlQnVja2V0SW5QYXRoID0gYnVja2V0RW5kcG9pbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB7IGhvc3RuYW1lLCBidWNrZXRFbmRwb2ludCB9ID0gYnVja2V0SG9zdG5hbWUoe1xuICAgICAgICAgIGJ1Y2tldE5hbWUsXG4gICAgICAgICAgYmFzZUhvc3RuYW1lOiByZXF1ZXN0Lmhvc3RuYW1lLFxuICAgICAgICAgIGFjY2VsZXJhdGVFbmRwb2ludDogb3B0aW9ucy51c2VBY2NlbGVyYXRlRW5kcG9pbnQsXG4gICAgICAgICAgZHVhbHN0YWNrRW5kcG9pbnQ6IG9wdGlvbnMudXNlRHVhbHN0YWNrRW5kcG9pbnQsXG4gICAgICAgICAgcGF0aFN0eWxlRW5kcG9pbnQ6IG9wdGlvbnMuZm9yY2VQYXRoU3R5bGUsXG4gICAgICAgICAgdGxzQ29tcGF0aWJsZTogcmVxdWVzdC5wcm90b2NvbCA9PT0gXCJodHRwczpcIixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxdWVzdC5ob3N0bmFtZSA9IGhvc3RuYW1lO1xuICAgICAgICByZXBsYWNlQnVja2V0SW5QYXRoID0gYnVja2V0RW5kcG9pbnQ7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXBsYWNlQnVja2V0SW5QYXRoKSB7XG4gICAgICAgIHJlcXVlc3QucGF0aCA9IHJlcXVlc3QucGF0aC5yZXBsYWNlKC9eKFxcLyk/W15cXC9dKy8sIFwiXCIpO1xuICAgICAgICBpZiAocmVxdWVzdC5wYXRoID09PSBcIlwiKSB7XG4gICAgICAgICAgcmVxdWVzdC5wYXRoID0gXCIvXCI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV4dCh7IC4uLmFyZ3MsIHJlcXVlc3QgfSk7XG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCBidWNrZXRFbmRwb2ludE1pZGRsZXdhcmVPcHRpb25zOiBSZWxhdGl2ZU1pZGRsZXdhcmVPcHRpb25zID0ge1xuICB0YWdzOiBbXCJCVUNLRVRfRU5EUE9JTlRcIl0sXG4gIG5hbWU6IFwiYnVja2V0RW5kcG9pbnRNaWRkbGV3YXJlXCIsXG4gIHJlbGF0aW9uOiBcImJlZm9yZVwiLFxuICB0b01pZGRsZXdhcmU6IFwiaG9zdEhlYWRlck1pZGRsZXdhcmVcIixcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRCdWNrZXRFbmRwb2ludFBsdWdpbiA9IChvcHRpb25zOiBCdWNrZXRFbmRwb2ludFJlc29sdmVkQ29uZmlnKTogUGx1Z2dhYmxlPGFueSwgYW55PiA9PiAoe1xuICBhcHBseVRvU3RhY2s6IChjbGllbnRTdGFjaykgPT4ge1xuICAgIGNsaWVudFN0YWNrLmFkZFJlbGF0aXZlVG8oYnVja2V0RW5kcG9pbnRNaWRkbGV3YXJlKG9wdGlvbnMpLCBidWNrZXRFbmRwb2ludE1pZGRsZXdhcmVPcHRpb25zKTtcbiAgfSxcbn0pO1xuIl19