"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.bucketHostname = void 0;
var tslib_1 = require("tslib");
var bucketHostnameUtils_1 = require("./bucketHostnameUtils");
exports.bucketHostname = function (options) {
    var baseHostname = options.baseHostname;
    if (!bucketHostnameUtils_1.S3_HOSTNAME_PATTERN.test(baseHostname)) {
        return {
            bucketEndpoint: false,
            hostname: baseHostname,
        };
    }
    if (bucketHostnameUtils_1.isBucketNameOptions(options)) {
        // Construct endpoint when bucketName is a string referring to a bucket name
        return getEndpointFromBucketName(options);
    }
    else {
        // Construct endpoint when bucketName is an ARN referring to an S3 resource like Access Point
        return {
            bucketEndpoint: true,
            hostname: getEndpointFromAccessPoint(options),
        };
    }
};
var getEndpointFromAccessPoint = function (options) {
    // Infer client region and hostname suffix from hostname from endpoints.json, like `s3.us-west-2.amazonaws.com`
    var _a = tslib_1.__read(bucketHostnameUtils_1.getSuffixForArnEndpoint(options.baseHostname), 2), clientRegion = _a[0], hostnameSuffix = _a[1];
    var pathStyleEndpoint = options.pathStyleEndpoint, dualstackEndpoint = options.dualstackEndpoint, accelerateEndpoint = options.accelerateEndpoint, _b = options.tlsCompatible, tlsCompatible = _b === void 0 ? true : _b, useArnRegion = options.useArnRegion, bucketName = options.bucketName, _c = options.clientPartition, clientPartition = _c === void 0 ? "aws" : _c, _d = options.clientSigningRegion, clientSigningRegion = _d === void 0 ? clientRegion : _d;
    if (pathStyleEndpoint) {
        throw new Error("Path-style S3 endpoint is not supported when bucket is an Access Point ARN");
    }
    if (accelerateEndpoint) {
        throw new Error("Accelerate is not supported when bucket is an Access Point ARN");
    }
    if (!tlsCompatible) {
        throw new Error("Access Point can only be used with https");
    }
    // Validate and parse the ARN supplied as a bucket name
    var service = bucketName.service, partition = bucketName.partition, accountId = bucketName.accountId, region = bucketName.region, resource = bucketName.resource;
    bucketHostnameUtils_1.validateService(service);
    bucketHostnameUtils_1.validateRegion(region, { useArnRegion: useArnRegion, clientRegion: clientRegion, clientSigningRegion: clientSigningRegion });
    bucketHostnameUtils_1.validatePartition(partition, { clientPartition: clientPartition });
    bucketHostnameUtils_1.validateAccountId(accountId);
    var accessPointName = bucketHostnameUtils_1.getAccessPointName(resource);
    bucketHostnameUtils_1.validateDNSHostLabel(accessPointName + "-" + accountId, { tlsCompatible: tlsCompatible });
    return accessPointName + "-" + accountId + ".s3-accesspoint" + (dualstackEndpoint ? ".dualstack" : "") + "." + (useArnRegion ? region : clientRegion) + "." + hostnameSuffix;
};
var getEndpointFromBucketName = function (_a) {
    var _b = _a.accelerateEndpoint, accelerateEndpoint = _b === void 0 ? false : _b, baseHostname = _a.baseHostname, bucketName = _a.bucketName, _c = _a.dualstackEndpoint, dualstackEndpoint = _c === void 0 ? false : _c, _d = _a.pathStyleEndpoint, pathStyleEndpoint = _d === void 0 ? false : _d, _e = _a.tlsCompatible, tlsCompatible = _e === void 0 ? true : _e;
    var _f = tslib_1.__read(bucketHostnameUtils_1.getSuffix(baseHostname), 2), clientRegion = _f[0], hostnameSuffix = _f[1];
    if (pathStyleEndpoint || !bucketHostnameUtils_1.isDnsCompatibleBucketName(bucketName) || (tlsCompatible && bucketHostnameUtils_1.DOT_PATTERN.test(bucketName))) {
        return {
            bucketEndpoint: false,
            hostname: dualstackEndpoint ? "s3.dualstack." + clientRegion + "." + hostnameSuffix : baseHostname,
        };
    }
    if (accelerateEndpoint) {
        baseHostname = "s3-accelerate" + (dualstackEndpoint ? ".dualstack" : "") + "." + hostnameSuffix;
    }
    else if (dualstackEndpoint) {
        baseHostname = "s3.dualstack." + clientRegion + "." + hostnameSuffix;
    }
    return {
        bucketEndpoint: true,
        hostname: bucketName + "." + baseHostname,
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0SG9zdG5hbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYnVja2V0SG9zdG5hbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDZEQWUrQjtBQU9sQixRQUFBLGNBQWMsR0FBRyxVQUFDLE9BQWlEO0lBQ3RFLElBQUEsWUFBWSxHQUFLLE9BQU8sYUFBWixDQUFhO0lBQ2pDLElBQUksQ0FBQyx5Q0FBbUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUU7UUFDM0MsT0FBTztZQUNMLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLFFBQVEsRUFBRSxZQUFZO1NBQ3ZCLENBQUM7S0FDSDtJQUNELElBQUkseUNBQW1CLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDaEMsNEVBQTRFO1FBQzVFLE9BQU8seUJBQXlCLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDM0M7U0FBTTtRQUNMLDZGQUE2RjtRQUM3RixPQUFPO1lBQ0wsY0FBYyxFQUFFLElBQUk7WUFDcEIsUUFBUSxFQUFFLDBCQUEwQixDQUFDLE9BQU8sQ0FBQztTQUM5QyxDQUFDO0tBQ0g7QUFDSCxDQUFDLENBQUM7QUFFRixJQUFNLDBCQUEwQixHQUFHLFVBQUMsT0FBMEI7SUFDNUQsK0dBQStHO0lBQ3pHLElBQUEsS0FBQSxlQUFpQyw2Q0FBdUIsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUEsRUFBN0UsWUFBWSxRQUFBLEVBQUUsY0FBYyxRQUFpRCxDQUFDO0lBRW5GLElBQUEsaUJBQWlCLEdBUWYsT0FBTyxrQkFSUSxFQUNqQixpQkFBaUIsR0FPZixPQUFPLGtCQVBRLEVBQ2pCLGtCQUFrQixHQU1oQixPQUFPLG1CQU5TLEVBQ2xCLEtBS0UsT0FBTyxjQUxXLEVBQXBCLGFBQWEsbUJBQUcsSUFBSSxLQUFBLEVBQ3BCLFlBQVksR0FJVixPQUFPLGFBSkcsRUFDWixVQUFVLEdBR1IsT0FBTyxXQUhDLEVBQ1YsS0FFRSxPQUFPLGdCQUZjLEVBQXZCLGVB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IEFybkhvc3RuYW1lUGFyYW1zLFxuICBCdWNrZXRIb3N0bmFtZVBhcmFtcyxcbiAgRE9UX1BBVFRFUk4sXG4gIGdldEFjY2Vzc1BvaW50TmFtZSxcbiAgZ2V0U3VmZml4LFxuICBnZXRTdWZmaXhGb3JBcm5FbmRwb2ludCxcbiAgaXNCdWNrZXROYW1lT3B0aW9ucyxcbiAgaXNEbnNDb21wYXRpYmxlQnVja2V0TmFtZSxcbiAgUzNfSE9TVE5BTUVfUEFUVEVSTixcbiAgdmFsaWRhdGVBY2NvdW50SWQsXG4gIHZhbGlkYXRlRE5TSG9zdExhYmVsLFxuICB2YWxpZGF0ZVBhcnRpdGlvbixcbiAgdmFsaWRhdGVSZWdpb24sXG4gIHZhbGlkYXRlU2VydmljZSxcbn0gZnJvbSBcIi4vYnVja2V0SG9zdG5hbWVVdGlsc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJ1Y2tldEhvc3RuYW1lIHtcbiAgaG9zdG5hbWU6IHN0cmluZztcbiAgYnVja2V0RW5kcG9pbnQ6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjb25zdCBidWNrZXRIb3N0bmFtZSA9IChvcHRpb25zOiBCdWNrZXRIb3N0bmFtZVBhcmFtcyB8IEFybkhvc3RuYW1lUGFyYW1zKTogQnVja2V0SG9zdG5hbWUgPT4ge1xuICBjb25zdCB7IGJhc2VIb3N0bmFtZSB9ID0gb3B0aW9ucztcbiAgaWYgKCFTM19IT1NUTkFNRV9QQVRURVJOLnRlc3QoYmFzZUhvc3RuYW1lKSkge1xuICAgIHJldHVybiB7XG4gICAgICBidWNrZXRFbmRwb2ludDogZmFsc2UsXG4gICAgICBob3N0bmFtZTogYmFzZUhvc3RuYW1lLFxuICAgIH07XG4gIH1cbiAgaWYgKGlzQnVja2V0TmFtZU9wdGlvbnMob3B0aW9ucykpIHtcbiAgICAvLyBDb25zdHJ1Y3QgZW5kcG9pbnQgd2hlbiBidWNrZXROYW1lIGlzIGEgc3RyaW5nIHJlZmVycmluZyB0byBhIGJ1Y2tldCBuYW1lXG4gICAgcmV0dXJuIGdldEVuZHBvaW50RnJvbUJ1Y2tldE5hbWUob3B0aW9ucyk7XG4gIH0gZWxzZSB7XG4gICAgLy8gQ29uc3RydWN0IGVuZHBvaW50IHdoZW4gYnVja2V0TmFtZSBpcyBhbiBBUk4gcmVmZXJyaW5nIHRvIGFuIFMzIHJlc291cmNlIGxpa2UgQWNjZXNzIFBvaW50XG4gICAgcmV0dXJuIHtcbiAgICAgIGJ1Y2tldEVuZHBvaW50OiB0cnVlLFxuICAgICAgaG9zdG5hbWU6IGdldEVuZHBvaW50RnJvbUFjY2Vzc1BvaW50KG9wdGlvbnMpLFxuICAgIH07XG4gIH1cbn07XG5cbmNvbnN0IGdldEVuZHBvaW50RnJvbUFjY2Vzc1BvaW50ID0gKG9wdGlvbnM6IEFybkhvc3RuYW1lUGFyYW1zKTogc3RyaW5nID0+IHtcbiAgLy8gSW5mZXIgY2xpZW50IHJlZ2lvbiBhbmQgaG9zdG5hbWUgc3VmZml4IGZyb20gaG9zdG5hbWUgZnJvbSBlbmRwb2ludHMuanNvbiwgbGlrZSBgczMudXMtd2VzdC0yLmFtYXpvbmF3cy5jb21gXG4gIGNvbnN0IFtjbGllbnRSZWdpb24sIGhvc3RuYW1lU3VmZml4XSA9IGdldFN1ZmZpeEZvckFybkVuZHBvaW50KG9wdGlvbnMuYmFzZUhvc3RuYW1lKTtcbiAgY29uc3Qge1xuICAgIHBhdGhTdHlsZUVuZHBvaW50LFxuICAgIGR1YWxzdGFja0VuZHBvaW50LFxuICAgIGFjY2VsZXJhdGVFbmRwb2ludCxcbiAgICB0bHNDb21wYXRpYmxlID0gdHJ1ZSxcbiAgICB1c2VBcm5SZWdpb24sXG4gICAgYnVja2V0TmFtZSxcbiAgICBjbGllbnRQYXJ0aXRpb24gPSBcImF3c1wiLFxuICAgIGNsaWVudFNpZ25pbmdSZWdpb24gPSBjbGllbnRSZWdpb24sXG4gIH0gPSBvcHRpb25zO1xuXG4gIGlmIChwYXRoU3R5bGVFbmRwb2ludCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlBhdGgtc3R5bGUgUzMgZW5kcG9pbnQgaXMgbm90IHN1cHBvcnRlZCB3aGVuIGJ1Y2tldCBpcyBhbiBBY2Nlc3MgUG9pbnQgQVJOXCIpO1xuICB9XG4gIGlmIChhY2NlbGVyYXRlRW5kcG9pbnQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBY2NlbGVyYXRlIGlzIG5vdCBzdXBwb3J0ZWQgd2hlbiBidWNrZXQgaXMgYW4gQWNjZXNzIFBvaW50IEFSTlwiKTtcbiAgfVxuICBpZiAoIXRsc0NvbXBhdGlibGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBY2Nlc3MgUG9pbnQgY2FuIG9ubHkgYmUgdXNlZCB3aXRoIGh0dHBzXCIpO1xuICB9XG4gIC8vIFZhbGlkYXRlIGFuZCBwYXJzZSB0aGUgQVJOIHN1cHBsaWVkIGFzIGEgYnVja2V0IG5hbWVcbiAgY29uc3QgeyBzZXJ2aWNlLCBwYXJ0aXRpb24sIGFjY291bnRJZCwgcmVnaW9uLCByZXNvdXJjZSB9ID0gYnVja2V0TmFtZTtcbiAgdmFsaWRhdGVTZXJ2aWNlKHNlcnZpY2UpO1xuICB2YWxpZGF0ZVJlZ2lvbihyZWdpb24sIHsgdXNlQXJuUmVnaW9uLCBjbGllbnRSZWdpb24sIGNsaWVudFNpZ25pbmdSZWdpb24gfSk7XG4gIHZhbGlkYXRlUGFydGl0aW9uKHBhcnRpdGlvbiwgeyBjbGllbnRQYXJ0aXRpb24gfSk7XG4gIHZhbGlkYXRlQWNjb3VudElkKGFjY291bnRJZCk7XG4gIGNvbnN0IGFjY2Vzc1BvaW50TmFtZSA9IGdldEFjY2Vzc1BvaW50TmFtZShyZXNvdXJjZSk7XG4gIHZhbGlkYXRlRE5TSG9zdExhYmVsKGAke2FjY2Vzc1BvaW50TmFtZX0tJHthY2NvdW50SWR9YCwgeyB0bHNDb21wYXRpYmxlIH0pO1xuXG4gIHJldHVybiBgJHthY2Nlc3NQb2ludE5hbWV9LSR7YWNjb3VudElkfS5zMy1hY2Nlc3Nwb2ludCR7ZHVhbHN0YWNrRW5kcG9pbnQgPyBcIi5kdWFsc3RhY2tcIiA6IFwiXCJ9LiR7XG4gICAgdXNlQXJuUmVnaW9uID8gcmVnaW9uIDogY2xpZW50UmVnaW9uXG4gIH0uJHtob3N0bmFtZVN1ZmZpeH1gO1xufTtcblxuY29uc3QgZ2V0RW5kcG9pbnRGcm9tQnVja2V0TmFtZSA9ICh7XG4gIGFjY2VsZXJhdGVFbmRwb2ludCA9IGZhbHNlLFxuICBiYXNlSG9zdG5hbWUsXG4gIGJ1Y2tldE5hbWUsXG4gIGR1YWxzdGFja0VuZHBvaW50ID0gZmFsc2UsXG4gIHBhdGhTdHlsZUVuZHBvaW50ID0gZmFsc2UsXG4gIHRsc0NvbXBhdGlibGUgPSB0cnVlLFxufTogQnVja2V0SG9zdG5hbWVQYXJhbXMpOiBCdWNrZXRIb3N0bmFtZSA9PiB7XG4gIGNvbnN0IFtjbGllbnRSZWdpb24sIGhvc3RuYW1lU3VmZml4XSA9IGdldFN1ZmZpeChiYXNlSG9zdG5hbWUpO1xuICBpZiAocGF0aFN0eWxlRW5kcG9pbnQgfHwgIWlzRG5zQ29tcGF0aWJsZUJ1Y2tldE5hbWUoYnVja2V0TmFtZSkgfHwgKHRsc0NvbXBhdGlibGUgJiYgRE9UX1BBVFRFUk4udGVzdChidWNrZXROYW1lKSkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgYnVja2V0RW5kcG9pbnQ6IGZhbHNlLFxuICAgICAgaG9zdG5hbWU6IGR1YWxzdGFja0VuZHBvaW50ID8gYHMzLmR1YWxzdGFjay4ke2NsaWVudFJlZ2lvbn0uJHtob3N0bmFtZVN1ZmZpeH1gIDogYmFzZUhvc3RuYW1lLFxuICAgIH07XG4gIH1cblxuICBpZiAoYWNjZWxlcmF0ZUVuZHBvaW50KSB7XG4gICAgYmFzZUhvc3RuYW1lID0gYHMzLWFjY2VsZXJhdGUke2R1YWxzdGFja0VuZHBvaW50ID8gXCIuZHVhbHN0YWNrXCIgOiBcIlwifS4ke2hvc3RuYW1lU3VmZml4fWA7XG4gIH0gZWxzZSBpZiAoZHVhbHN0YWNrRW5kcG9pbnQpIHtcbiAgICBiYXNlSG9zdG5hbWUgPSBgczMuZHVhbHN0YWNrLiR7Y2xpZW50UmVnaW9ufS4ke2hvc3RuYW1lU3VmZml4fWA7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGJ1Y2tldEVuZHBvaW50OiB0cnVlLFxuICAgIGhvc3RuYW1lOiBgJHtidWNrZXROYW1lfS4ke2Jhc2VIb3N0bmFtZX1gLFxuICB9O1xufTtcbiJdfQ==