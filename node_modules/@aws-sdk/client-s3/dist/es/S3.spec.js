import { __awaiter, __generator } from "tslib";
/// <reference types="mocha" />
import { expect } from "chai";
import { S3 } from "./S3";
describe("endpoint", function () {
    it("users can override endpoint from client.", function () { return __awaiter(void 0, void 0, void 0, function () {
        var endpointValidator, client;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    endpointValidator = function (next) { return function (args) {
                        // middleware intercept the request and return it early
                        var request = args.request;
                        expect(request.protocol).to.equal("http:");
                        expect(request.hostname).to.equal("localhost");
                        expect(request.port).to.equal(8080);
                        //query and path should not be overwritten
                        expect(request.query).not.to.contain({ foo: "bar" });
                        expect(request.path).not.to.equal("/path");
                        return Promise.resolve({ output: {}, response: {} });
                    }; };
                    client = new S3({ endpoint: "http://localhost:8080/path?foo=bar" });
                    client.middlewareStack.add(endpointValidator, {
                        step: "serialize",
                        name: "endpointValidator",
                        priority: "low",
                    });
                    return [4 /*yield*/, client.putObject({
                            Bucket: "bucket",
                            Key: "key",
                            Body: "body",
                        })];
                case 1: return [2 /*return*/, _a.sent()];
            }
        });
    }); });
});
describe("Accesspoint ARN", function () { return __awaiter(void 0, void 0, void 0, function () {
    var endpointValidator;
    return __generator(this, function (_a) {
        endpointValidator = function (next, context) { return function (args) {
            // middleware intercept the request and return it early
            var request = args.request;
            return Promise.resolve({
                output: {
                    $metadata: { attempts: 0, httpStatusCode: 200 },
                    request: request,
                    context: context,
                },
                response: {},
            });
        }; };
        it("should succeed with access point ARN", function () { return __awaiter(void 0, void 0, void 0, function () {
            var client, result;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        client = new S3({});
                        client.middlewareStack.add(endpointValidator, { step: "finalizeRequest", priority: "low" });
                        return [4 /*yield*/, client.putObject({
                                Bucket: "arn:aws:s3:us-west-2:123456789012:accesspoint:myendpoint",
                                Key: "key",
                                Body: "body",
                            })];
                    case 1:
                        result = _a.sent();
                        expect(result.request.hostname).to.eql("myendpoint-123456789012.s3-accesspoint.us-west-2.amazonaws.com");
                        return [2 /*return*/];
                }
            });
        }); });
        it("should sign request with region from ARN is useArnRegion is set", function () { return __awaiter(void 0, void 0, void 0, function () {
            var client, result;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        client = new S3({ region: "us-east-1", useArnRegion: true });
                        client.middlewareStack.add(endpointValidator, { step: "finalizeRequest", priority: "low" });
                        return [4 /*yield*/, client.putObject({
                                Bucket: "arn:aws:s3:us-west-2:123456789012:accesspoint:myendpoint",
                                Key: "key",
                                Body: "body",
                            })];
                    case 1:
                        result = _a.sent();
                        expect(result.request.hostname).to.eql("myendpoint-123456789012.s3-accesspoint.us-west-2.amazonaws.com");
                        // Sign request with us-west-2 region from bucket access point ARN
                        expect(result.request.headers.authorization).to.contain("/us-west-2/s3/aws4_request, SignedHeaders=");
                        return [2 /*return*/];
                }
            });
        }); });
        return [2 /*return*/];
    });
}); });
//# sourceMappingURL=S3.spec.js.map