import{r as t,h as i,c as s,H as e,g as o}from"./p-8fb49ffc.js";import{Logger as r,browserOrNode as a,I18n as n}from"@aws-amplify/core";import"@aws-amplify/auth";import{T as h}from"./p-915bcfdd.js";import{d as l}from"./p-2915ed18.js";import{Interactions as d}from"@aws-amplify/interactions";const c=(t,i,s)=>{for(let e=0;e<s.length;e++)t.setUint8(i+e,s.charCodeAt(e))},m=(t,i,s,e)=>{const o=((t,i)=>{const s=2*t.length,e=8+s,o=new ArrayBuffer(36+e),r=new DataView(o);return c(r,0,"RIFF"),r.setUint32(4,24+e,!0),c(r,8,"WAVE"),c(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,i,!0),r.setUint32(28,2*i,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),c(r,36,"data"),r.setUint32(40,s,!0),((t,i,s)=>{let e=44;for(let o=0;o<s.length;o++,e+=2){const i=Math.max(-1,Math.min(1,s[o]));t.setInt16(e,i<0?32768*i:32767*i,!0)}})(r,0,t),r})(((t,i,s)=>{if(s===i)return t;const e=i/s,o=Math.round(t.length/e),r=new Float32Array(o);let a=0,n=0;for(;a<r.length;){const i=Math.round((a+1)*e);let s=0,o=0;for(let e=n;e<i&&e<t.length;e++)s+=t[e],o++;r[a]=s/o,a++,n=i}return r})(((t,i)=>{const s=new Float32Array(i);let e=0;for(let o=0;o<t.length;o++)s.set(t[o],e),e+=t[o].length;return s})(t,i),s,e),e);return new Blob([o],{type:"application/octet-stream"})},f=new r("AudioRecorder");class u{constructor(t){this.streamBuffer=[],this.streamBufferLength=0,this.recording=!1,this.options=t}async init(){if(!a().isBrowser)return this.audioSupported=!1,Promise.reject("Audio is not supported");window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{this.audioSupported=!0,this.setupAudioNodes(t)}).catch(()=>(this.audioSupported=!1,Promise.reject("Audio is not supported")))}async setupAudioNodes(t){try{await this.audioContext.resume()}catch(o){f.error(o)}const i=this.audioContext.createMediaStreamSource(t),s=this.audioContext.createScriptProcessor(4096,1,1);s.onaudioprocess=t=>{if(!this.recording)return;const i=t.inputBuffer.getChannelData(0);this.streamBuffer.push(new Float32Array(i)),this.streamBufferLength+=i.length,this.analyse()};const e=this.audioContext.createAnalyser();e.minDecibels=-90,e.maxDecibels=-10,e.smoothingTimeConstant=.85,i.connect(e),e.connect(s),s.connect(i.context.destination),this.analyserNode=e}async startRecording(t,i){if(this.recording||!this.audioSupported)return;this.onSilence=t||function(){},this.visualizer=i||function(){};const s=this.audioContext;try{await s.resume()}catch(e){f.error(e)}this.start=Date.now(),this.recording=!0}stopRecording(){this.audioSupported&&(this.recording=!1)}clear(){this.stopRecording(),this.streamBufferLength=0,this.streamBuffer=[]}play(t){if(!t||!this.audioSupported)return;const i=new Blob([t]);return new Promise((t,s)=>{const e=new FileReader;e.onload=()=>{this.playbackSource&&this.playbackSource.disconnect(),this.playbackSource=this.audioContext.createBufferSource(),this.audioContext.decodeAudioData(e.result,i=>{this.playbackSource.buffer=i,this.playbackSource.connect(this.audioContext.destination),this.playbackSource.onended=()=>t(),this.playbackSource.start(0)},t=>s(t))},e.onerror=()=>s(),e.readAsArrayBuffer(i)})}stop(){this.playbackSource&&this.playbackSource.stop()}analyse(){if(!this.audioSupported)return;const t=this.analyserNode;t.fftSize=2048;const i=t.fftSize,s=new Uint8Array(i),e=this.options.amplitude,o=this.options.time;t.getByteTimeDomainData(s),this.visualizer(s,i);for(let r=0;r<i;r++){const t=s[r]/128-1;(t>e||t<-1*e)&&(this.start=Date.now())}Date.now()-this.start>o&&this.onSilence()}async exportWAV(t=16e3){if(!this.audioSupported)return;const i=m(this.streamBuffer,this.streamBufferLength,this.audioContext.sampleRate,t);return this.clear(),i}}var b,p,g;!function(t){t[t.Initial=0]="Initial",t[t.Listening=1]="Listening",t[t.SendingText=2]="SendingText",t[t.SendingVoice=3]="SendingVoice",t[t.Error=4]="Error"}(b||(b={})),function(t){t.Bot="bot",t.User="user"}(p||(p={})),function(t){t[t.Recoverable=0]="Recoverable",t[t.Unrecoverable=1]="Unrecoverable"}(g||(g={}));const y=class{constructor(e){t(this,e),this.clearOnComplete=!1,this.conversationModeOn=!1,this.botTitle=h.CHATBOT_TITLE,this.voiceEnabled=!1,this.textEnabled=!0,this.silenceTime=1500,this.silenceThreshold=.2,this.messages=[],this.text="",this.chatState=b.Initial,this.messageJSX=t=>{const s=t.map(t=>i("div",{class:"bubble "+t.from},t.content));if(this.chatState===b.SendingText||this.chatState===b.SendingVoice){const t=this.chatState===b.SendingText?p.Bot:p.User;s.push(i("div",{class:"bubble "+t},i("div",{class:"dot-flashing "+t},i("span",{class:"dot left"}),i("span",{class:"dot middle"}),i("span",{class:"dot right"}))))}return s},this.chatCompleted=s(this,"chatCompleted",7)}submitHandler(t){this.sendTextMessage()}componentWillLoad(){if(!d||"function"!=typeof d.onComplete)throw new Error(l);this.validateProps()}componentDidRender(){const t=this.element.shadowRoot.querySelector(".body");t.scrollTop=t.scrollHeight}validateProps(){if(!this.voiceEnabled&&!this.textEnabled)return void this.setError(h.CHAT_DISABLED_ERROR,g.Unrecoverable);if(!this.botName)return void this.setError(h.NO_BOT_NAME_ERROR,g.Unrecoverable);this.welcomeMessage&&this.appendToChat(this.welcomeMessage,p.Bot),this.voiceEnabled&&(this.audioRecorder=new u({time:this.silenceTime,amplitude:this.silenceThreshold}),this.audioRecorder.init().catch(t=>{this.setError(t,g.Recoverable)}));const t=(t,i)=>{this.chatCompleted.emit({data:i,err:t}),this.clearOnComplete?this.reset():this.chatState=b.Initial};try{d.onComplete(this.botName,t)}catch(i){this.setError(i,g.Unrecoverable)}}handleMicButton(){this.chatState===b.Initial&&(this.audioRecorder.stop(),this.chatState=b.Listening,this.audioRecorder.startRecording(()=>this.handleSilence(),(t,i)=>this.visualizer(t,i)))}handleSilence(){this.chatState=b.SendingVoice,this.audioRecorder.stopRecording(),this.audioRecorder.exportWAV().then(t=>{this.sendVoiceMessage(t)})}handleTextChange(t){this.text=t.target.value}handleCancelButton(){this.audioRecorder.clear(),this.chatState=b.Initial}handleToastClose(t){this.error=void 0,t===g.Recoverable&&(this.chatState=b.Initial)}visualizer(t,i){((t,i,s)=>{if(!s)return;if(!a().isBrowser)throw new Error("Visualization is not supported on non-browsers.");const{width:e,height:o}=s.getBoundingClientRect();s.width=e,s.height=o;const r=s.getContext("2d");r.fillStyle="white",r.clearRect(0,0,e,o),requestAnimationFrame(()=>{r.fillRect(0,0,e,o),r.lineWidth=1;const a=getComputedStyle(document.documentElement).getPropertyValue("--amplify-primary-color");r.strokeStyle=a&&""!==a?a:"#ff9900",r.beginPath();const n=1*e/i;let h=0;for(let s=0;s<i||s%3==0;s++){const i=t[s]/128*o/2;0===s?r.moveTo(h,i):r.lineTo(h,i),h+=n}r.lineTo(s.width,s.height/2),r.stroke()})})(t,i,this.element.shadowRoot.querySelector("canvas"))}async sendTextMessage(){if(0===this.text.length||this.chatState!==b.Initial)return;const t=this.text;let i;this.text="",this.appendToChat(t,p.User),this.chatState=b.SendingText;try{i=await d.send(this.botName,t)}catch(s){return void this.setError(s,g.Recoverable)}i.message&&this.appendToChat(i.message,p.Bot),this.chatState=b.Initial}async sendVoiceMessage(t){const i={content:t,options:{messageType:"voice"}};let s;try{s=await d.send(this.botName,i)}catch(o){return void this.setError(o,g.Recoverable)}this.chatState=b.Initial;const e=s.dialogState;s.inputTranscript&&this.appendToChat(s.inputTranscript,p.User),this.appendToChat(s.message,p.Bot),await this.audioRecorder.play(s.audioStream).then(()=>{this.conversationModeOn&&"Fulfilled"!==e&&"Failed"!==e&&this.chatState===b.Initial&&this.handleMicButton()}).catch(t=>this.setError(t,g.Recoverable))}appendToChat(t,i){this.messages=[...this.messages,{content:t,from:i}]}setError(t,i){const s="string"==typeof t?t:t.message;this.chatState=b.Error,this.error={message:s,errorType:i}}reset(){this.chatState=b.Initial,this.text="",this.error=void 0,this.messages=[],this.welcomeMessage&&this.appendToChat(this.welcomeMessage,p.Bot),this.audioRecorder&&this.audioRecorder.clear()}listeningFooterJSX(){return[i("canvas",{height:"50"}),i("amplify-button",{"data-test":"chatbot-cancel-button",handleButtonClick:()=>this.handleCancelButton(),class:"icon-button",variant:"icon",icon:"ban"})]}footerJSX(){return this.chatState===b.Listening?this.listeningFooterJSX():[i("amplify-input",{placeholder:n.get(this.textEnabled?h.TEXT_INPUT_PLACEHOLDER:h.VOICE_INPUT_PLACEHOLDER),description:"text",handleInputChange:t=>this.handleTextChange(t),value:this.text,disabled:this.chatState===b.Error||!this.textEnabled}),this.voiceEnabled&&i("amplify-button",{"data-test":"chatbot-mic-button",handleButtonClick:()=>this.handleMicButton(),class:"icon-button",variant:"icon",icon:"microphone",disabled:this.chatState===b.Error||this.chatState!==b.Initial}),this.textEnabled&&i("amplify-button",{"data-test":"chatbot-send-button",class:"icon-button",variant:"icon",icon:"send",handleButtonClick:()=>this.sendTextMessage(),disabled:this.chatState===b.Error||this.chatState!==b.Initial})]}errorToast(){if(!this.error)return;const{message:t,errorType:s}=this.error;return i("amplify-toast",{message:n.get(t),handleClose:()=>this.handleToastClose(s)})}render(){return i(e,null,i("div",{class:"amplify-chatbot"},i("slot",{name:"header"},i("div",{class:"header","data-test":"chatbot-header"},n.get(this.botTitle))),i("div",{class:"body","data-test":"chatbot-body"},this.messageJSX(this.messages)),i("div",{class:"footer","data-test":"chatbot-footer"},this.footerJSX()),this.errorToast()))}get element(){return o(this)}};y.style=".bot .dot{background-color:var(--bot-dot-color)}.user .dot{background-color:var(--user-dot-color)}.dot-flashing{width:2.625rem}.dot-flashing .dot{display:inline-block;width:0.625rem;height:0.625rem;border-radius:10rem;opacity:0.65}.dot-flashing .left{-webkit-animation:dot-flashing 1s infinite alternate;animation:dot-flashing 1s infinite alternate;-webkit-animation-delay:0s;animation-delay:0s}.dot-flashing .middle{margin-left:0.375rem;margin-right:0.375rem;-webkit-animation:dot-flashing 1s infinite linear alternate;animation:dot-flashing 1s infinite linear alternate;-webkit-animation-delay:0.5s;animation-delay:0.5s}.dot-flashing .right{-webkit-animation:dot-flashing 1s infinite alternate;animation:dot-flashing 1s infinite alternate;-webkit-animation-delay:1s;animation-delay:1s}@-webkit-keyframes dot-flashing{0%{opacity:0.65}50%,100%{opacity:0.1}}@keyframes dot-flashing{0%{opacity:0.65}50%,100%{opacity:0.1}}:host{--width:28.75rem;--height:37.5rem;--header-color:var(--amplify-secondary-color);--header-size:var(--amplify-text-lg);--bot-background-color:rgb(230, 230, 230);--bot-text-color:black;--bot-dot-color:var(--bot-text-color);--user-background-color:var(--amplify-blue);--user-text-color:var(--amplify-white);--user-dot-color:var(--user-text-color)}.amplify-chatbot{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-direction:column;flex-direction:column;background-color:var(--background-color);border-radius:0.375rem;-webkit-box-shadow:0.0625rem 0rem 0.25rem 0 rgba(0, 0, 0, 0.15);box-shadow:0.0625rem 0rem 0.25rem 0 rgba(0, 0, 0, 0.15);-webkit-box-sizing:border-box;box-sizing:border-box;font-family:var(--amplify-font-family);margin-bottom:1rem;width:100%;height:var(--height);max-width:var(--width)}@media (min-width: 672px){.amplify-chatbot{width:var(--width)}}.header{padding:1.25rem 0.375rem 1.25rem 0.375rem;color:var(--header-color);font-size:var(--header-size);font-weight:bold;text-align:center;word-wrap:break-word}.body{border-top:0.0625rem solid rgba(0, 0, 0, 0.05);padding:1.5rem 1rem 0 1rem;display:-ms-flexbox;display:flex;-ms-flex-positive:1;flex-grow:1;-ms-flex-direction:column;flex-direction:column;overflow:auto}.bubble{max-width:100%;padding:0.8em 1.4em;text-align:left;word-wrap:break-word;margin-bottom:0.625rem}.bot{margin-right:auto;background-color:var(--bot-background-color);color:var(--bot-text-color);border-radius:1.5rem 1.5rem 1.5rem 0}.user{margin-left:auto;background-color:var(--user-background-color);color:var(--user-text-color);border-radius:1.5rem 1.5rem 0 1.5rem}.footer{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;border-top:0.062rem solid rgba(0, 0, 0, 0.05);padding-right:0.625rem;min-height:3.125rem}.footer amplify-input{--border:none;--margin:0;-ms-flex-positive:1;flex-grow:1}canvas{margin-left:0.625rem;margin-right:0.625rem;-ms-flex-positive:1;flex-grow:1;height:3.125rem}.icon-button{--icon-height:1.25rem;--icon-fill:var(--amplify-primary-color);--padding:0.625rem;--width:auto}";export{y as amplify_chatbot}